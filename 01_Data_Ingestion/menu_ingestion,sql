/* Tasty Bytes â€“ Snowflake Data Ingestion Pipeline */

-- Step 1: Set Role, Warehouse, Database, and Schema
USE ROLE SNOWFLAKE_LEARNING_ROLE;
USE WAREHOUSE SNOWFLAKE_LEARNING_WH;
USE DATABASE SNOWFLAKE_LEARNING_DB;

SET schema_name = CONCAT(current_user(), '_LOAD_SAMPLE_DATA_FROM_S3');
USE SCHEMA IDENTIFIER($schema_name);

-- Step 2: Create Raw Menu Table
CREATE OR REPLACE TABLE MENU (
    menu_id NUMBER(19,0),
    menu_type_id NUMBER(38,0),
    menu_type VARCHAR,
    truck_brand_name VARCHAR,
    menu_item_id NUMBER(38,0),
    menu_item_name VARCHAR,
    item_category VARCHAR,
    item_subcategory VARCHAR,
    cost_of_goods_usd NUMBER(38,4),
    sale_price_usd NUMBER(38,4),
    menu_item_health_metrics_obj VARIANT
);

-- Step 3: Create External Stage for S3
CREATE OR REPLACE STAGE blob_stage
URL = 's3://sfquickstarts/tastybytes/'
FILE_FORMAT = (TYPE = CSV);

-- Step 4: Load Data into Menu Table
COPY INTO MENU
FROM @blob_stage/raw_pos/menu/;

-- Step 5: Basic Queries
SELECT COUNT(*) AS row_count FROM MENU;
SELECT TOP 10 * FROM MENU;
SELECT menu_item_name FROM MENU WHERE truck_brand_name = 'Freezing Point';
